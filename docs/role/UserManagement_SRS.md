【Project-Tsurugi Internal Use Only】

# ユーザ管理機能 要件定義書

2021.06.18 初版(Rev.0.1)  
2021.07.07 改版(Rev.0.2)

## 目的

DBMSとして一般的に要求されるAAA機能（Authentication, Authorization, Accounting）について基盤となる仕組みと一部機能を開発する。例えば、DBMS上のテーブルやビューなどのデータベースオブジェクトに対して適切なアクセス権限を付与できるようにし、適切なユーザのみがリソースにアクセス可能とする。AAA機能の内容としてはPostgreSQLの内容をベースとするが、Tsurugiの特徴であるOLTPとOLAPのリソースを透過的に操作、管理できることを意識した設計を行う。

## 用語

- Tsurugi

  NEDOプロジェクトで開発するDBMS全体を指す。

- OLTP

  TsurugiのうちのOLTP部分を指す。

- OLTPテーブル

  OLTP上に定義されたテーブル。

- OLTP外部テーブル

  FDWにおける外部テーブルのうち、OLTPテーブルに関連付けられた外部テーブルを指す。

- クライアント

  統合メタデータ管理基盤を利用してテーブルや統計情報などのメタデータを操作する役割を持ったアプリケーションプログラム。

  - 具体的な想定
    - OLTP関連モジュール（ogawayamaなど）

- データベースオブジェクト

  データベースを構成するオブジェクト。
  - データベースオブジェクトの種類（PostgreSQL）

    ```text
      テーブル、
      列、
      ビュー、
      外部テーブル、
      シーケンス、
      データベース、
      外部データラッパ、
      外部サーバ、
      関数、
      プロシージャ、
      手続き言語、
      スキーマ、
      テーブル空間
    ```

## ユースケース

<https://github.com/project-tsurugi/architecture/blob/master/usecases/Usecases.md>

- [UC-17]オブジェクトを定義する
- [UC-28]オブジェクトに権限を付与する
- [UC-53]オブジェクトの権限を取り消す

## ユーザストーリー（具体的なユースケース）

### a. ロールを制御する

- スーパーユーザが、新しいロールを作成する
- ロール所有者が、ロールを削除する
- ロール作成権限を持たないロールが、新しいロールの作成に失敗する

### b. データベースオブジェクトへの権限を制御する

- スーパーユーザが、ロールにOLTPテーブルへのSELECT権限を付与する
- OLTPテーブルの所有者が、ロールが持つOLTPテーブルへのTRUNCATE権限を取り消す
- OLTPテーブルの非所有者が、ロールにOLTPテーブルへのINSERT権限を付与できない

### c. 利用者が正当な権限を持っていることを認証する

- アプリケーションが、JDBC経由でOLTPに直接接続した場合にユーザ認証に必要な情報または機能を提供する

### d. クライアントが統合メタデータ管理基盤からメタデータを取得する

- クライアントが、統合メタデータ管理基盤からROLEのメタデータを取得する
- クライアントが、統合メタデータ管理基盤からTABLEのメタデータ（アクセス権限情報を含む）を取得する

## 開発スコープ

- Authorization機能（認可機能）の対象となるデータベースオブジェクトと権限の範囲は以下のとおりとする
  - OLTPテーブル
  - ビュー
  - 関数

  <https://www.postgresql.jp/document/12/html/sql-grant.html>
  <https://www.postgresql.jp/document/12/html/ddl-priv.html>

## 機能一覧

1. データベースロール制御機能

    スーパーユーザまたはロール制御権限を保持するロールは、データベースロールを作成／削除／変更できる。

    | # | 機能名 | 説明 | 備考 |
    |---|---|---|---|
    |1. | ロール作成機能      | ロールを作成する。       | CREATE ROLEを想定。 |
    |2. | ロール削除機能      | ロールを削除する。       | DROP ROLEを想定。   |
    |3. | ロール属性変更機能  | ロールの属性を変更する。 | ALTER ROLEを想定。  |

1. データベースオブジェクトへのアクセス権限制御機能
  
    スーパーユーザまたはデータベースオブジェクトの所有者は、データベースオブジェクトのアクセス権限をデータベースロールに付与したり、取り消したりできる。

    - 対象データベースオブジェクト：OLTPテーブル

    | # | 機能名 | 説明 | 備考 |
    |---|---|---|---|
    |1. | アクセス権限付与機能  | 権限を付与する。  | GRANTを想定。 |
    |2. | アクセス権限取消機能  | 権限を削除する。  | REVOKEを想定。|

1. ユーザ認証機能

    Tsurugiの各コンポーネントに対して統合メタデータ管理基盤が管理する認証情報を活用した認証機能を提供する。

## 機能要件

### データベースロール制御機能［RLE］

1. ロールの作成

    システムは、スーパーユーザまたはロール作成権限を保有するロールからの要求によって、データベース内にロールを作成する。

    備考：PostgreSQLのCREATE ROLEコマンドの投入によって実現されることが望ましい。

    1. システムは、ロール作成権限を保有しないロールからロールの作成を要求された場合は、エラーを返す。

1. ロールの削除

    システムは、スーパーユーザまたはロール所有者からの要求によって、データベース内のロールを削除する。

    備考：PostgreSQLのDROP ROLEコマンドの投入によって実現されることが望ましい。

    1. システムは、ロール非所有者からロールの削除を要求された場合は、エラーを返す（スーパーユーザを除く）

1. ロール属性の変更

    システムは、スーパーユーザまたはロール所有者からの要求によって、ロール属性を変更する。

    備考：PostgreSQLのALTER ROLEコマンドの投入によって実現されることが望ましい。

    1. システムは、ロール非所有者からロール属性の変更を要求された場合は、エラーを返す（スーパーユーザを除く）

### データベースオブジェクトへのアクセス権限制御機能［ACL］

1. アクセス権限の付与

    システムは、スーパーユーザまたはデータベースオブジェクトの所有者からの要求によって、データベースオブジェクトのアクセス権限をロールに付与する。

    |#| 対象データベースオブジェクト | 対象アクセス権限 |
    |---|---|---|
    |1.| OLTPテーブル, ビュー | SELECT, INSERT, UPDATE, DELETE, TRUNCATE <BR>（スコープ外：REFERENCES, TRIGGER） |
    |2.| ユーザ定義関数       | EXECUTE |

    備考：PostgreSQLのGRANTコマンドの投入によって実現されることが望ましい。

    1. システムは、データベースオブジェクトの非所有者からアクセス権限の付与を要求された場合は、エラーを返す（スーパーユーザを除く）

1. アクセス権限の取り消し

    システムは、スーパーユーザまたはデータベースオブジェクトの所有者からの要求によって、データベースオブジェクトのアクセス権限をロールから取り消す。
    |#| 対象データベースオブジェクト | 対象アクセス権限 |
    |---|---|---|
    |1.| OLTPテーブル, ビュー | SELECT, INSERT, UPDATE, DELETE, TRUNCATE <BR>（スコープ外：REFERENCES, TRIGGER） |
    |2.| ユーザ定義関数       | EXECUTE |

    備考：PostgreSQLのREVOKEコマンドの投入によって実現されることが望ましい。

    1. システムは、データベースオブジェクトの非所有者からアクセス権限の取り消しを要求された場合は、エラーを返す（スーパーユーザを除く）

### 認証［AUTH］

1. ユーザ認証

    システムは、クライアントからの要求によって、クライアントから提供されたユーザ情報とPostgreSQL上の認証情報を利用して認証を行う

    具体的な認証方法：JDBC APIのgetConnection()のパラメータによって認証できることを想定する

### メタデータ提供機能 ［MED］

1. ロールメタデータの提供

    システムは、クライアントからの要求によって、権限情報を含むロールメタデータを提供する

1. テーブルメタデータの提供

    システムは、クライアントからの要求によって、権限情報を含むテーブルメタデータを提供する

1. ビューメタデータの提供

    システムは、クライアントからの要求によって、権限情報を含むビューメタデータを提供する

1. プロシージャメタデータの提供

    システムは、クライアントからの要求によって、権限情報を含むプロシージャメタデータを提供する

### 非機能要件［NFR］

1. 応答時間

    システムは、アクタから投入されたコマンドの実行結果を以下の応答時間内に返す。
    - 応答時間（成功時）： 3秒以内
    - 理由：UXにおける一般的に期待される応答時間。

### 考慮事項［OTH］

将来の機能拡張（スコープ拡大）を考慮した設計を行う。

1. 対象となるデータベースオブジェクトとして以下のオブジェクトが追加されることを考慮して設計する
    - OLAP上のテーブル（OLAPテーブル）
    - HTAPテーブル

以上
